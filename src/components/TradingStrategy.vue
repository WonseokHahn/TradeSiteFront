<template>
  <div class="strategy-form">
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">ìë™ë§¤ë§¤ ì „ëµ ì„¤ì •</h2>
      </div>
      
      <div class="card-body">
        <!-- ì‹œì¥ ìƒíƒœ ì„ íƒ - í–¥ìƒëœ ë²„ì „ -->
        <div class="form-group">
          <label class="form-label">ì‹œì¥ ìƒíƒœ ë° ì „ëµ ì„ íƒ</label>
          <div class="market-options">
            <label class="market-option">
              <input 
                type="radio" 
                v-model="strategy.marketType" 
                value="bull"
                class="market-radio"
              >
              <div class="market-card bull">
                <div class="market-icon">ğŸ“ˆ</div>
                <div class="market-label">ìƒìŠ¹ì¥ ëª¨ë©˜í…€ ì „ëµ</div>
                <div class="market-desc">
                  <strong>ê¸°ìˆ ì  ë¶„ì„ ê¸°ë°˜ ë§¤ë§¤:</strong><br>
                  â€¢ RSI, MACD, ì´ë™í‰ê· ì„  ë¶„ì„<br>
                  â€¢ ê³¨ë“ í¬ë¡œìŠ¤ ì‹œ ë§¤ìˆ˜ ì‹ í˜¸<br>
                  â€¢ ëª¨ë©˜í…€ ì§€ì†ì„± í™•ì¸ í›„ ì§„ì…<br>
                  â€¢ ê³¼ë§¤ìˆ˜ êµ¬ê°„ì—ì„œ ì¼ë¶€ ë§¤ë„
                </div>
                <div class="strategy-indicators">
                  <span class="indicator">RSI 30-70</span>
                  <span class="indicator">MACDâ†—</span>
                  <span class="indicator">MAì •ë°°ì—´</span>
                </div>
              </div>
            </label>
            
            <label class="market-option">
              <input 
                type="radio" 
                v-model="strategy.marketType" 
                value="bear"
                class="market-radio"
              >
              <div class="market-card bear">
                <div class="market-icon">ğŸ“‰</div>
                <div class="market-label">í•˜ë½ì¥ ê°€ì¹˜íˆ¬ì ì „ëµ</div>
                <div class="market-desc">
                  <strong>ì—­ì¶”ì„¸ ë§¤ë§¤ ë° ì†ì ˆê´€ë¦¬:</strong><br>
                  â€¢ RSI ê³¼ë§¤ë„ êµ¬ê°„ ë§¤ìˆ˜<br>
                  â€¢ ë³¼ë¦°ì €ë°´ë“œ í•˜ë‹¨ í„°ì¹˜ì‹œ ì§„ì…<br>
                  â€¢ ì¥ê¸° ì´í‰ì„  ì´íƒˆì‹œ ì†ì ˆ<br>
                  â€¢ ë¶„í•  ë§¤ìˆ˜ë¡œ ë¦¬ìŠ¤í¬ ë¶„ì‚°
                </div>
                <div class="strategy-indicators">
                  <span class="indicator">RSI &lt;30</span>
                  <span class="indicator">ë³¼ë¦°ì €í•˜ë‹¨</span>
                  <span class="indicator">ê°€ì¹˜ë§¤ìˆ˜</span>
                </div>
              </div>
            </label>
          </div>
          
          <!-- ì„ íƒëœ ì „ëµì˜ ìƒì„¸ ì„¤ëª… -->
          <div v-if="strategy.marketType" class="strategy-details">
            <div class="strategy-detail-card">
              <h4 class="detail-title">
                {{ strategy.marketType === 'bull' ? 'ìƒìŠ¹ì¥ ëª¨ë©˜í…€ ì „ëµ' : 'í•˜ë½ì¥ ê°€ì¹˜íˆ¬ì ì „ëµ' }} ìƒì„¸ ì •ë³´
              </h4>
              
              <div v-if="strategy.marketType === 'bull'" class="strategy-explanation">
                <div class="explanation-section">
                  <h5>ğŸ“Š ì‚¬ìš©í•˜ëŠ” ê¸°ìˆ ì  ì§€í‘œ</h5>
                  <ul>
                    <li><strong>RSI (14ì¼):</strong> 30-70 êµ¬ê°„ì—ì„œ ë§¤ìˆ˜, 80 ì´ìƒì‹œ ë§¤ë„</li>
                    <li><strong>ì´ë™í‰ê· ì„ :</strong> 5ì¼ì„  &gt; 20ì¼ì„  ì •ë°°ì—´ì‹œ ë§¤ìˆ˜ ì‹ í˜¸</li>
                    <li><strong>MACD:</strong> ê³¨ë“ í¬ë¡œìŠ¤ í˜•ì„±ì‹œ ë§¤ìˆ˜ ì§„ì…</li>
                    <li><strong>ëª¨ë©˜í…€:</strong> 10ì¼ê°„ +5% ì´ìƒì‹œ ì¶”ê°€ ë§¤ìˆ˜</li>
                  </ul>
                </div>
                
                <div class="explanation-section">
                  <h5>âš¡ ë§¤ë§¤ ì‹¤í–‰ ë¡œì§</h5>
                  <ul>
                    <li>ì‹ í˜¸ ê°•ë„ 40ì  ì´ìƒì‹œ ë§¤ìˆ˜ ì‹¤í–‰</li>
                    <li>ì‹ í˜¸ ê°•ë„ì— ë”°ë¼ íˆ¬ì ë¹„ì¤‘ ì¡°ì ˆ (ìµœëŒ€ 120%)</li>
                    <li>30ë¶„ ê°„ê²©ìœ¼ë¡œ ì¤‘ë³µ ì£¼ë¬¸ ë°©ì§€</li>
                    <li>ê³¼ë§¤ìˆ˜ ì‹ í˜¸ì‹œ ë³´ìœ ëŸ‰ì˜ 30-80% ë§¤ë„</li>
                  </ul>
                </div>
              </div>
              
              <div v-else class="strategy-explanation">
                <div class="explanation-section">
                  <h5>ğŸ“Š ì‚¬ìš©í•˜ëŠ” ê¸°ìˆ ì  ì§€í‘œ</h5>
                  <ul>
                    <li><strong>RSI (14ì¼):</strong> 30 ë¯¸ë§Œ ê³¼ë§¤ë„ì‹œ ë§¤ìˆ˜, 70 ì´ìƒì‹œ ë§¤ë„</li>
                    <li><strong>ë³¼ë¦°ì €ë°´ë“œ:</strong> í•˜ë‹¨ í„°ì¹˜ì‹œ ë§¤ìˆ˜, ìƒë‹¨ ë„ë‹¬ì‹œ ë§¤ë„</li>
                    <li><strong>50ì¼ ì´ë™í‰ê· :</strong> 10% ì´ìƒ í•˜ë½ì‹œ ê°€ì¹˜ë§¤ìˆ˜</li>
                    <li><strong>ì¥ê¸° ëª¨ë©˜í…€:</strong> 20ì¼ê°„ -15% ì´ìƒ í•˜ë½ì‹œ ì§„ì…</li>
                  </ul>
                </div>
                
                <div class="explanation-section">
                  <h5>ğŸ›¡ï¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë¡œì§</h5>
                  <ul>
                    <li>ë¶„í•  ë§¤ìˆ˜ë¡œ í‰ê·  ë‹¨ê°€ ë‚®ì¶”ê¸°</li>
                    <li>ê·¹ì‹¬í•œ í•˜ë½(-25%)ì‹œ ì†ì ˆë§¤ ì‹¤í–‰</li>
                    <li>ê³¼ë§¤ìˆ˜ êµ¬ê°„ì—ì„œ ì ì§„ì  ë§¤ë„</li>
                    <li>í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ë°¸ëŸ°ì‹± ìë™ ì œì•ˆ</li>
                  </ul>
                </div>
              </div>
              
              <div class="strategy-warning">
                <div class="warning-icon">âš ï¸</div>
                <div class="warning-text">
                  <strong>ì£¼ì˜ì‚¬í•­:</strong> ëª¨ë“  ê¸°ìˆ ì  ë¶„ì„ì€ ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë©°, 
                  ë¯¸ë˜ ìˆ˜ìµì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íˆ¬ìì— ë”°ë¥¸ ì†ì‹¤ì˜ ì±…ì„ì€ íˆ¬ìì ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- íˆ¬ì ì§€ì—­ ì„ íƒ -->
        <div class="form-group">
          <label class="form-label">íˆ¬ì ì§€ì—­</label>
          <div class="region-options">
            <label class="region-option">
              <input 
                type="radio" 
                v-model="strategy.region" 
                value="domestic"
                class="region-radio"
                @change="onRegionChange"
              >
              <div class="region-card">
                <span class="region-flag">ğŸ‡°ğŸ‡·</span>
                <span class="region-text">êµ­ë‚´ íˆ¬ì</span>
              </div>
            </label>
            
            <label class="region-option">
              <input 
                type="radio" 
                v-model="strategy.region" 
                value="global"
                class="region-radio"
                @change="onRegionChange"
              >
              <div class="region-card">
                <span class="region-flag">ğŸŒ</span>
                <span class="region-text">í•´ì™¸ íˆ¬ì</span>
              </div>
            </label>
          </div>
        </div>

        <!-- ì‹œì¥ ìƒíƒœ ì •ë³´ í‘œì‹œ -->
        <div class="form-group">
          <label class="form-label">
            í˜„ì¬ ì‹œì¥ ìƒíƒœ 
            <span class="api-source">(í•œêµ­íˆ¬ìì¦ê¶Œ API ì‹¤ì‹œê°„)</span>
          </label>
          <div class="market-status-info">
            <div v-if="marketStatusLoading" class="market-status-loading">
              <div class="loading-spinner"></div>
              <span>KIS APIë¡œ ì‹œì¥ ìƒíƒœ í™•ì¸ ì¤‘...</span>
            </div>
            <div v-else-if="marketStatus" class="market-status-display">
              <div class="market-status-item" :class="{ 'market-open': marketStatus.isOpen, 'market-closed': !marketStatus.isOpen }">
                <div class="status-indicator">
                  <span class="status-dot" :class="{ 'open': marketStatus.isOpen, 'closed': !marketStatus.isOpen }"></span>
                  <span class="status-text">{{ marketStatus.statusText }}</span>
                </div>
                <div class="market-details">
                  <small class="api-info">
                    {{ marketStatus.source === 'KIS_API' ? 'ğŸŸ¢ ì‹¤ì‹œê°„ API ë°ì´í„°' : 
                       marketStatus.source === 'FALLBACK_TIME' ? 'ğŸŸ¡ ì‹œê°„ ê¸°ë°˜ ì¶”ì •' : 'ğŸ”´ API ì˜¤ë¥˜' }}
                  </small>
                  <small class="check-time">
                    ë§ˆì§€ë§‰ í™•ì¸: {{ formatDateTime(marketStatus.checkedAt) }}
                  </small>
                  <small v-if="marketStatus.error" class="error-info">
                    ì˜¤ë¥˜: {{ marketStatus.error }}
                  </small>
                </div>
              </div>
              <div class="status-actions">
                <button @click="refreshMarketStatus" class="btn btn-sm btn-outline refresh-btn">
                  ğŸ”„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨
                </button>
                <small class="auto-refresh-info">2ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨</small>
              </div>
            </div>
            <div v-else class="market-status-error">
              <span>âŒ ì‹œì¥ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
              <button @click="loadMarketStatus" class="btn btn-sm btn-outline">ë‹¤ì‹œ ì‹œë„</button>
            </div>
            
            <!-- ì‹œì¥ ë§ˆê° ì‹œ ê°•í™”ëœ ê²½ê³  ë©”ì‹œì§€ -->
            <div v-if="marketStatus && !marketStatus.isOpen" class="market-warning enhanced">
              <div class="warning-icon">ğŸš«</div>
              <div class="warning-content">
                <strong>ìë™ë§¤ë§¤ ì‹œì‘ ë¶ˆê°€</strong>
                <p>{{ marketStatus.message }}</p>
                <p class="warning-notice">
                  í•œêµ­íˆ¬ìì¦ê¶Œ APIì—ì„œ ì‹œì¥ì´ ë§ˆê°ë˜ì—ˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤. 
                  ì‹œì¥ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ìë™ë§¤ë§¤ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
              </div>
            </div>
            
            <!-- ì‹œì¥ ê°œì¥ ì‹œ í™•ì¸ ë©”ì‹œì§€ -->
            <div v-if="marketStatus && marketStatus.isOpen" class="market-success">
              <div class="success-icon">âœ…</div>
              <div class="success-content">
                <strong>ìë™ë§¤ë§¤ ì‹œì‘ ê°€ëŠ¥</strong>
                <p>{{ marketStatus.message }}</p>
                <p class="success-notice">
                  ì‹¤ì‹œê°„ API í™•ì¸ ê²°ê³¼ ì‹œì¥ì´ ì—´ë ¤ìˆì–´ ìë™ë§¤ë§¤ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- ì”ê³  ì •ë³´ í‘œì‹œ -->
        <div class="form-group">
          <label class="form-label">íˆ¬ì ê°€ëŠ¥ ê¸ˆì•¡</label>
          <div class="balance-info">
            <div v-if="balanceLoading" class="balance-loading">
              <div class="loading-spinner"></div>
              <span>ì”ê³  ì¡°íšŒ ì¤‘...</span>
            </div>
            <div v-else-if="accountBalance" class="balance-display">
              <div class="balance-item">
                <span class="balance-label">ì´ ì˜ˆìˆ˜ê¸ˆ:</span>
                <span class="balance-value">{{ formatCurrency(accountBalance.totalDeposit, strategy.region) }}</span>
              </div>
              <div class="balance-item">
                <span class="balance-label">ì£¼ë¬¸ ê°€ëŠ¥ ê¸ˆì•¡:</span>
                <span class="balance-value available">{{ formatCurrency(accountBalance.availableAmount, strategy.region) }}</span>
              </div>
            </div>
            <div v-else class="balance-error">
              <span>ì”ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
              <button @click="loadAccountBalance" class="btn btn-sm btn-outline">ë‹¤ì‹œ ì‹œë„</button>
            </div>
          </div>
        </div>

        <!-- ì¢…ëª© êµ¬ì„± ì„¤ì • -->
        <div class="form-group">
          <label class="form-label">ì¢…ëª© êµ¬ì„±</label>
          <div class="stocks-container">
            <div 
              v-for="(stock, index) in strategy.stocks" 
              :key="index"
              class="stock-item"
            >
              <div class="stock-inputs">
                <input 
                  type="text" 
                  v-model="stock.code"
                  :placeholder="strategy.region === 'domestic' ? 'ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)' : 'í‹°ì»¤ (ì˜ˆ: AAPL)'"
                  class="form-input stock-code"
                  @blur="validateStockCode(index)"
                  :disabled="stock.validating"
                >
                <input 
                  type="text" 
                  v-model="stock.name"
                  placeholder="ì¢…ëª©ëª…"
                  class="form-input stock-name"
                  readonly
                >
                <div class="allocation-input-group">
                  <input 
                    type="number" 
                    v-model="stock.allocation"
                    min="1"
                    max="100"
                    placeholder="ë¹„ìœ¨"
                    class="form-input allocation-input"
                    @input="updateTotalAllocation"
                  >
                  <span class="allocation-unit">%</span>
                </div>
                <button 
                  v-if="strategy.stocks.length > 1"
                  @click="removeStock(index)"
                  class="btn-remove"
                  type="button"
                >
                  Ã—
                </button>
              </div>
              <div v-if="stock.validating" class="validation-loading">
                <div class="loading-spinner"></div>
                <span>ì¢…ëª© ì •ë³´ í™•ì¸ ì¤‘...</span>
              </div>
              <div v-if="stock.error" class="form-error">
                {{ stock.error }}
              </div>
              <div v-if="stock.price" class="stock-price">
                í˜„ì¬ê°€: {{ formatCurrency(stock.price, strategy.region) }}
              </div>
            </div>
            
            <button 
              @click="addStock"
              class="btn btn-outline btn-sm add-stock-btn"
              type="button"
            >
              + ì¢…ëª© ì¶”ê°€
            </button>
            
            <div class="allocation-summary">
              <span class="total-allocation" :class="{ 'over-100': totalAllocation > 100 }">
                ì´ íˆ¬ì ë¹„ìœ¨: {{ totalAllocation }}%
              </span>
              <span v-if="totalAllocation > 100" class="allocation-warning">
                (100%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤)
              </span>
              <span v-if="totalAllocation < 100" class="allocation-info">
                (ë‚¨ì€ ë¹„ìœ¨: {{ 100 - totalAllocation }}%)
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card-footer">
        <div class="strategy-actions">
          <div class="trading-status">
            <span v-if="isTrading" class="status-indicator active">
              <span class="status-dot"></span>
              ìë™ë§¤ë§¤ ì‹¤í–‰ ì¤‘
            </span>
            <span v-else class="status-indicator inactive">
              <span class="status-dot"></span>
              ìë™ë§¤ë§¤ ëŒ€ê¸° ì¤‘
            </span>
          </div>
          
          <div class="action-buttons">
            <button 
              v-if="!isTrading"
              @click="handleStartTrading"
              :disabled="!isValidStrategy || loading || (marketStatus && !marketStatus.isOpen)"
              class="btn btn-success"
            >
              <span v-if="loading" class="loading-spinner"></span>
              ìë™ë§¤ë§¤ ì‹œì‘
            </button>
            
            <button 
              v-if="isTrading"
              @click="handleStopTrading"
              :disabled="loading"
              class="btn btn-danger"
            >
              <span v-if="loading" class="loading-spinner"></span>
              ìë™ë§¤ë§¤ ì¢…ë£Œ
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
import { mapGetters, mapActions } from 'vuex'
import apiClient from '@/utils/api'

export default {
  name: 'TradingStrategy',
  data() {
    return {
      strategy: {
        marketType: 'bull',
        region: 'domestic',
        stocks: [
          { code: '', name: '', allocation: 50, error: null, validating: false, price: null }
        ]
      },
      totalAllocation: 50,
      accountBalance: null,
      balanceLoading: false,
      marketStatus: null,
      marketStatusLoading: false,
      marketStatusTimer: null
    }
  },
  computed: {
    ...mapGetters('trading', ['isTrading', 'currentStrategy', 'isLoading']),
    
    loading() {
      return this.isLoading
    },
    
    debugTradingState() {
      const state = {
        isTrading: this.isTrading,
        currentStrategy: this.currentStrategy,
        isLoading: this.isLoading
      };
      console.log('ğŸ” í˜„ì¬ íŠ¸ë ˆì´ë”© ìƒíƒœ:', state);
      return state;
    },
    
    isValidStrategy() {
      return this.strategy.marketType && 
             this.strategy.region &&
             this.strategy.stocks.every(stock => stock.code && stock.allocation > 0) &&
             this.totalAllocation > 0 &&
             this.totalAllocation <= 100 &&
             !this.strategy.stocks.some(stock => stock.error || stock.validating)
    }
  },
  async created() {
    await this.loadTradingStatus()
    await this.loadAccountBalance()
    await this.loadMarketStatus()
    
    // í˜„ì¬ í™œì„± ì „ëµì´ ìˆìœ¼ë©´ í¼ì— ë¡œë“œ
    if (this.currentStrategy) {
      this.loadCurrentStrategy()
    }
  },
  mounted() {
    // 2ë¶„ë§ˆë‹¤ ì‹œì¥ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨
    this.startMarketStatusAutoRefresh();
  },
  beforeUnmount() {
    this.stopMarketStatusAutoRefresh();
  },
  methods: {
    ...mapActions('trading', [
      'loadTradingStatus', 
      'createStrategy',
      'startTrading',
      'stopTrading'
    ]),

    loadCurrentStrategy() {
      if (this.currentStrategy) {
        this.strategy = {
          marketType: this.currentStrategy.marketType,
          region: this.currentStrategy.region,
          stocks: this.currentStrategy.stocks || [{ code: '', name: '', allocation: 50, error: null, validating: false, price: null }]
        }
        this.updateTotalAllocation()
      }
    },

    async onRegionChange() {
      // ì§€ì—­ ë³€ê²½ì‹œ ì”ê³  ë‹¤ì‹œ ì¡°íšŒ ë° ì¢…ëª© ì •ë³´ ì´ˆê¸°í™”
      this.loadAccountBalance()
      this.strategy.stocks.forEach(stock => {
        stock.name = ''
        stock.error = null
        stock.price = null
      })
      
      // íƒ€ì´ë¨¸ ì¬ì‹œì‘
      this.stopMarketStatusAutoRefresh();
      await this.loadMarketStatus();
      this.startMarketStatusAutoRefresh();
    },

    async loadAccountBalance() {
      this.balanceLoading = true
      try {
        const endpoint = this.strategy.region === 'domestic' 
          ? '/trading/account/balance/domestic'
          : '/trading/account/balance/global'

        const response = await apiClient.get(endpoint)
        if (response.data.success) {
          this.accountBalance = response.data.data
        }
      } catch (error) {
        console.error('ì”ê³  ì¡°íšŒ ì‹¤íŒ¨:', error)
        this.accountBalance = null
      } finally {
        this.balanceLoading = false
      }
    },

    async loadMarketStatus() {
      if (!this.strategy.region) return;
      
      this.marketStatusLoading = true;
      try {
        const response = await apiClient.get('/trading/market-status', {
          params: { region: this.strategy.region }
        });
        
        if (response.data.success) {
          this.marketStatus = response.data.data;
          console.log('ğŸ“Š ì‹œì¥ ìƒíƒœ ë¡œë“œ ì™„ë£Œ:', this.marketStatus);
        }
      } catch (error) {
        console.error('âŒ ì‹œì¥ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
        this.marketStatus = null;
      } finally {
        this.marketStatusLoading = false;
      }
    },

    async refreshMarketStatus() {
      await this.loadMarketStatus();
      if (this.$toast) {
        this.$toast.success('ì‹œì¥ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    },

    startMarketStatusAutoRefresh() {
      console.log('ğŸ”„ ì‹œì¥ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (2ë¶„ ê°„ê²©)');
      
      this.marketStatusTimer = setInterval(async () => {
        if (this.strategy.region) {
          console.log('ğŸ• ì‹œì¥ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨...');
          await this.loadMarketStatus();
        }
      }, 2 * 60 * 1000); // 2ë¶„ë§ˆë‹¤
    },

    stopMarketStatusAutoRefresh() {
      if (this.marketStatusTimer) {
        console.log('â¹ï¸ ì‹œì¥ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨ ì¤‘ë‹¨');
        clearInterval(this.marketStatusTimer);
        this.marketStatusTimer = null;
      }
    },

    addStock() {
      if (this.strategy.stocks.length < 10) { // ìµœëŒ€ 10ê°œ ì¢…ëª©
        this.strategy.stocks.push({ 
          code: '', 
          name: '', 
          allocation: 0, 
          error: null, 
          validating: false,
          price: null
        })
      }
    },

    removeStock(index) {
      this.strategy.stocks.splice(index, 1)
      this.updateTotalAllocation()
    },

    updateTotalAllocation() {
      this.totalAllocation = this.strategy.stocks.reduce((sum, stock) => {
        return sum + (parseInt(stock.allocation) || 0)
      }, 0)
    },

    async validateStockCode(index) {
      const stock = this.strategy.stocks[index]
      if (!stock.code) {
        stock.error = null
        stock.name = ''
        stock.price = null
        return
      }

      stock.validating = true
      stock.error = null

      try {
        let endpoint, validationResponse

        if (this.strategy.region === 'domestic') {
          // êµ­ë‚´ ì£¼ì‹ ì½”ë“œ ê²€ì¦ (6ìë¦¬ ìˆ«ì)
          if (!/^\d{6}$/.test(stock.code)) {
            stock.error = 'ì˜¬ë°”ë¥¸ ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (6ìë¦¬ ìˆ«ì)'
            stock.name = ''
            stock.price = null
            return
          }

          endpoint = '/trading/stock/info/domestic'
          validationResponse = await apiClient.get(endpoint, {
            params: { stockCode: stock.code }
          })

        } else {
          // í•´ì™¸ ì£¼ì‹ í‹°ì»¤ ê²€ì¦
          if (!/^[A-Z]{1,5}$/.test(stock.code.toUpperCase())) {
            stock.error = 'ì˜¬ë°”ë¥¸ í‹°ì»¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1-5ìë¦¬ ì˜ë¬¸)'
            stock.name = ''
            stock.price = null
            return
          }

          stock.code = stock.code.toUpperCase()
          endpoint = '/trading/stock/info/global'
          validationResponse = await apiClient.get(endpoint, {
            params: { ticker: stock.code }
          })
        }

        if (validationResponse.data.success) {
          const stockInfo = validationResponse.data.data
          stock.name = stockInfo.name
          stock.price = stockInfo.price
          stock.error = null
        } else {
          stock.error = validationResponse.data.message || 'ì¢…ëª© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
          stock.name = ''
          stock.price = null
        }

      } catch (error) {
        console.error('ì¢…ëª© ê²€ì¦ ì˜¤ë¥˜:', error)
        stock.error = 'ì¢…ëª© ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
        stock.name = ''
        stock.price = null
      } finally {
        stock.validating = false
      }
    },

    async handleStartTrading() {
      try {
        console.log('ğŸ” ìë™ë§¤ë§¤ ì‹œì‘ í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
        
        // 1ï¸âƒ£ ì‹œì¥ ìƒíƒœ ë¨¼ì € ì¬í™•ì¸
        console.log('ğŸ• ì‹œì¥ ìƒíƒœ ì¬í™•ì¸ ì¤‘...');
        await this.loadMarketStatus();
        
        if (this.marketStatus && !this.marketStatus.isOpen) {
          console.log('âŒ ì‹œì¥ ë§ˆê°ìœ¼ë¡œ ì¸í•œ ìë™ë§¤ë§¤ ì‹œì‘ ë¶ˆê°€');
          
          if (this.$toast) {
            this.$toast.error(`${this.marketStatus.statusText}\nì‹œì¥ì´ ì—´ë ¤ìˆì„ ë•Œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
          }
          return;
        }
        
        // 2ï¸âƒ£ ì „ëµ ë°ì´í„° ê²€ì¦
        console.log('ğŸ“Š ì „ëµ ë°ì´í„° ê²€ì¦ ì¤‘...');
        const strategyData = {
          marketType: this.strategy.marketType,
          region: this.strategy.region,
          stocks: this.strategy.stocks.map(stock => ({
            code: stock.code,
            name: stock.name || stock.code,
            allocation: parseInt(stock.allocation) || 0
          }))
        };
        
        console.log('ğŸ“¤ ì „ëµ ìƒì„±ìš© ë°ì´í„°:', JSON.stringify(strategyData, null, 2));
        
        // 3ï¸âƒ£ íˆ¬ì ë¹„ìœ¨ ê²€ì¦
        const totalAlloc = strategyData.stocks.reduce((sum, stock) => sum + stock.allocation, 0);
        console.log('ğŸ”¢ ê³„ì‚°ëœ ì´ íˆ¬ì ë¹„ìœ¨:', totalAlloc);
        
        if (totalAlloc !== 100) {
          console.error('âŒ íˆ¬ì ë¹„ìœ¨ ì˜¤ë¥˜:', totalAlloc);
          if (this.$toast) {
            this.$toast.error(`ì´ íˆ¬ì ë¹„ìœ¨ì´ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalAlloc}%)`);
          }
          return;
        }
        
        // 4ï¸âƒ£ ì „ëµ ìƒì„±
        console.log('âœï¸ ì „ëµ ìƒì„± ì¤‘...');
        const createSuccess = await this.createStrategy(strategyData);
        
        if (!createSuccess) {
          console.error('âŒ ì „ëµ ìƒì„± ì‹¤íŒ¨');
          if (this.$toast) {
            this.$toast.error('ì „ëµ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
          return;
        }
        
        console.log('âœ… ì „ëµ ìƒì„± ì„±ê³µ');
        
        // 5ï¸âƒ£ ì ì‹œ ê¸°ë‹¤ë ¤ì„œ currentStrategyê°€ ì—…ë°ì´íŠ¸ë˜ë„ë¡ í•¨
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // 6ï¸âƒ£ í˜„ì¬ ì „ëµ í™•ì¸
        const latestStrategy = this.currentStrategy;
        console.log('ğŸ“Š ìƒì„±ëœ ì „ëµ í™•ì¸:', latestStrategy);
        
        if (!latestStrategy || !latestStrategy.id) {
          console.error('âŒ ìƒì„±ëœ ì „ëµì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          
          // ìˆ˜ë™ìœ¼ë¡œ ì „ëµ ìƒíƒœ ë‹¤ì‹œ ë¡œë“œ ì‹œë„
          await this.loadTradingStatus();
          const retryStrategy = this.currentStrategy;
          
          if (!retryStrategy || !retryStrategy.id) {
            if (this.$toast) {
              this.$toast.error('ì „ëµ ìƒì„±ì€ ì„±ê³µí–ˆì§€ë§Œ ì „ëµ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            return;
          }
          
          console.log('âœ… ì¬ì‹œë„ë¡œ ì „ëµ ë°œê²¬:', retryStrategy);
        }
        
        const finalStrategy = latestStrategy || this.currentStrategy;
        
        // 7ï¸âƒ£ ìë™ë§¤ë§¤ ì‹œì‘
        console.log('ğŸš€ ìë™ë§¤ë§¤ ì‹œì‘ ì¤‘... strategyId:', finalStrategy.id, 'íƒ€ì…:', typeof finalStrategy.id);
        
        const startSuccess = await this.startTrading(finalStrategy.id);
        
        if (startSuccess) {
          console.log('âœ… ìë™ë§¤ë§¤ ì‹œì‘ ì„±ê³µ!');
          
          // 8ï¸âƒ£ ìƒíƒœ ê°•ì œ ìƒˆë¡œê³ ì¹¨
          await this.loadTradingStatus();
          await this.loadMarketStatus();
          
          if (this.$toast) {
            this.$toast.success('ğŸŸ¢ ì‹œì¥ì´ ì—´ë ¤ìˆì–´ ìë™ë§¤ë§¤ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        } else {
          console.error('âŒ ìë™ë§¤ë§¤ ì‹œì‘ ì‹¤íŒ¨ - startTrading ë©”ì„œë“œì—ì„œ false ë°˜í™˜');
          
          // ì‹œì¥ ìƒíƒœ ì¬í™•ì¸
          await this.loadMarketStatus();
          
          if (this.$toast) {
            this.$toast.error('ìë™ë§¤ë§¤ ì‹œì‘ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹œì¥ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
        }
        
      } catch (error) {
        console.error('âŒ handleStartTrading ì „ì²´ ì˜¤ë¥˜:', error);
        console.error('âŒ ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        
        if (error.response && error.response.data && error.response.data.message) {
          // ì„œë²„ì—ì„œ ì˜¨ êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
          console.error('ì„œë²„ ì˜¤ë¥˜ ë©”ì‹œì§€:', error.response.data.message);
          console.error('ì„œë²„ ì˜¤ë¥˜ ì „ì²´:', error.response.data);
          
          if (this.$toast) {
            this.$toast.error(error.response.data.message);
          }
          
          // ì‹œì¥ ìƒíƒœ ê´€ë ¨ ì˜¤ë¥˜ë©´ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
          if (error.response.data.reason === 'MARKET_CLOSED') {
            await this.loadMarketStatus();
          }
        } else {
          if (this.$toast) {
            this.$toast.error('ìë™ë§¤ë§¤ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }
      }
    },

    async handleStopTrading() {
      try {
        console.log('â¹ï¸ ìë™ë§¤ë§¤ ì¤‘ë‹¨ ìš”ì²­ ì‹œì‘');
        
        // 1ï¸âƒ£ ì¦‰ì‹œ UI ìƒíƒœë¥¼ falseë¡œ ì„¤ì • (ì‚¬ìš©ì ê²½í—˜ ê°œì„ )
        this.$store.commit('trading/SET_IS_TRADING', false);
        
        // 2ï¸âƒ£ ìë™ë§¤ë§¤ ì¤‘ë‹¨ API í˜¸ì¶œ
        const success = await this.stopTrading();
        
        if (success) {
          console.log('âœ… ìë™ë§¤ë§¤ ì¤‘ë‹¨ API ì„±ê³µ');
          
          // 3ï¸âƒ£ ì„œë²„ ìƒíƒœ ë™ê¸°í™”ë¥¼ ìœ„í•œ ì¶©ë¶„í•œ ì§€ì—°
          await new Promise(resolve => setTimeout(resolve, 1500));
          
          // 4ï¸âƒ£ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
          await this.loadTradingStatus();
          
          // 5ï¸âƒ£ í˜¹ì‹œ ëª¨ë¥¼ ìƒí™©ì„ ëŒ€ë¹„í•œ ì¶”ê°€ ì²´í¬
          const finalState = this.$store.getters['trading/isTrading'];
          console.log('ğŸ” ìµœì¢… í™•ì¸ëœ ìƒíƒœ:', finalState);
          
          if (finalState === true) {
            console.log('âš ï¸ ìƒíƒœê°€ ì—¬ì „íˆ true - ê°•ì œë¡œ false ì„¤ì •');
            this.$store.commit('trading/SET_IS_TRADING', false);
            this.$store.commit('trading/SET_CURRENT_STRATEGY', null);
          }
          
          // 6ï¸âƒ£ í† ìŠ¤íŠ¸ ë©”ì‹œì§€
          if (this.$toast) {
            this.$toast.success('ìë™ë§¤ë§¤ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
          
          console.log('âœ… ìë™ë§¤ë§¤ ì¤‘ë‹¨ ì²˜ë¦¬ ì™„ë£Œ');
        } else {
          console.error('âŒ ìë™ë§¤ë§¤ ì¤‘ë‹¨ API ì‹¤íŒ¨ - ìƒíƒœ ë³µì›');
          
          // API ì‹¤íŒ¨ì‹œ ìƒíƒœ ë³µì›
          await this.loadTradingStatus();
          
          if (this.$toast) {
            this.$toast.error('ìë™ë§¤ë§¤ ì¤‘ë‹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
      } catch (error) {
        console.error('âŒ handleStopTrading ì „ì²´ ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ë°œìƒì‹œ ìƒíƒœ ë³µì›
        await this.loadTradingStatus();
        
        if (this.$toast) {
          this.$toast.error('ìë™ë§¤ë§¤ ì¤‘ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }
    },
    
    formatCurrency(amount, region) {
      if (!amount) return '-'
    
      const numAmount = typeof amount === 'string' ? parseFloat(amount) : amount
      if (isNaN(numAmount)) return '-'
    
      if (region === 'domestic') {
        return numAmount.toLocaleString() + 'ì›'
      } else {
        return '$' + numAmount.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        })
      }
    },

    formatDateTime(dateString) {
      if (!dateString) return '-';
      
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '-';
        
        return date.toLocaleString('ko-KR', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (error) {
        return dateString;
      }
    }
  }
}
</script> 